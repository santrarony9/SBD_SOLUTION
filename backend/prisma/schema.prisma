// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// USER MANAGEMENT
// --------------------------------------

enum Role {
  ADMIN
  STAFF
  USER
  PRICE_MANAGER
}

enum Tier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

model User {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  email     String?   @unique
  password  String?
  mobile    String?   // Removed @unique to fix legacy data issues
  otp       String?
  otpExpiry DateTime?
  name      String
  role      Role      @default(USER)
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  cart      Cart?
  orders    Order[]
  wishlist  Wishlist[]
  reviews   Review[]
  addresses Address[] // Saved addresses
  // --------------------------------------
  // Shipping Labels (Zebra/Thermal Ready)
  // --------------------------------------
  // Geometry: 4x6 inch (288pt x 432pt) layout.
  // Content:
  // - High-contrast text for thermal printers.
  // - Simplified Address & Order ID.
  // - Weight & SKU details.
  // - Barcode/QR code for tracking sync.

  // --------------------------------------
  // Admin Print & Bulk UI
  // --------------------------------------
  // Bulk Selection: Ability to select multiple orders across the list.
  // Bulk Actions: 
  // - "Print Invoices": Generates a single PDF with all selected invoices (one per page).
  // - "Print Labels": Generates a single PDF with all selected labels (one per page).
  // Icons & UX: Professional Phosphor icons for Print/Label actions.

  // --------------------------------------
  // Verification Plan
  // --------------------------------------
  // 1. Label Layout: Verify the PDF dimensions are exactly 4x6 inches.
  // 2. Bulk Generation: Test selecting 5+ orders and generating the merged PDF.
  // 3. QR Code: Ensure the QR code on the label is readable and contains the order ID.
  // 4. Thermal Compatibility: Ensure all lines and text are high contrast (black on white).

  // CRM & Loyalty (Phase 24)
  tier           Tier      @default(BRONZE)
  loyaltyPoints  Int       @default(0)
  lifetimeSpend  Float     @default(0.0)
  
  birthday       DateTime?
  anniversaryDate DateTime?
  
  crmNotes       String?   // Internal staff notes
  loyaltyLogs    LoyaltyLog[]
}

// --------------------------------------
// MASTER DATA
// --------------------------------------

// 16K, 18K, 22K, 24K
model GoldPrice {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  purity      Int      @unique // e.g. 22
  pricePer10g Float
  isActive    Boolean  @default(true)
  updatedAt   DateTime @updatedAt
}

// VVS1, VS1, SI1, etc.
model DiamondPrice {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  clarity       String   @unique // e.g. "VVS1"
  pricePerCarat Float
  isActive      Boolean  @default(true)
  updatedAt     DateTime @updatedAt
}

// --------------------------------------
// DYNAMIC CHARGES
// --------------------------------------

enum ChargeType {
  FLAT
  PER_GRAM      // Usually for Gold Making Charges
  PER_CARAT     // Usually for Diamond
  PERCENTAGE    // e.g. for GST or heavy making charges
}

enum ApplyOn {
  GOLD_VALUE
  DIAMOND_VALUE
  SUBTOTAL      // (Gold + Diamond)
  FINAL_AMOUNT  // After other charges? Usually GST is on Subtotal + Making.
}

enum ChargeBasis {
  GOLD_WEIGHT   // For Per Gram
  DIAMOND_CARAT // For Per Carat
  GOLD_VALUE    // For % of Gold
  DIAMOND_VALUE // For % of Diamond
  RAW_TOTAL     // (GoldValue + DiamondValue) e.g. for general overhead %
  TAXABLE_VALUE // (GoldValue + DiamondValue + MakingCharges) - Used for GST
  FIXED         // Flat amount
}

model Charge {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  name        String      @unique // e.g. "Making Charges", "GST 3%"
  type        ChargeType  // FLAT, PER_GRAM, PER_CARAT, PERCENTAGE
  amount      Float       // The rate or fixed value
  
  applyOn     ApplyOn
  
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

// --------------------------------------
// PRODUCTS
// --------------------------------------

model Product {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String   @unique
  description String?
  
  // Core Specs
  goldPurity  Int      // 18, 22
  goldWeight  Float    // grams
  
  diamondClarity String // "VS1" - must match a DiamondPrice.clarity
  diamondCarat   Float
  diamondColor   String? // "E-F", "G-H"
  diamondCut     String? // "Excellent", "Very Good"
  
  // Certificate
  igiCertificateNumber String? 
  certificatePdf       String? // URL
  
  // Products
  category    String   // Rings, Necklaces, etc.
  
  // Media
  images      String[] // Support gallery
  videoUrl    String?  // Support product videos
  hsnCode     String?  @default("7113") // Default HSN for Gold Jewellery
  gstRate     Float?   @default(3.0)    // Default 3% for Precious items
  realWeight  Float?   // Actual weight in grams
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  isActive    Boolean  @default(true)

  // Inventory & Logistics
  sku         String?  @unique
  stockCount  Int      @default(0)
  isBespoke   Boolean  @default(false)
  
  vaultId     String?  @db.ObjectId
  vault       Vault?   @relation(fields: [vaultId], references: [id])
  
  cartItems   CartItem[]
  orderItems  OrderItem[]
  wishlistedBy Wishlist[]
  reviews      Review[]
}

model Offer {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  tag         String?   // e.g. "Limited Time"
  code        String?   // e.g. "ROYALFIRST"
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model PromoCode {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  code        String   @unique
  discountType String  // "FLAT", "PERCENTAGE"
  discountValue Float
  
  // Affiliate / Creator Ops
  creatorName String?
  usageCount  Int      @default(0)
  totalSales  Float    @default(0.0)
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --------------------------------------
// E-COMMERCE CORE
// --------------------------------------

model Cart {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?    @unique @db.ObjectId 
  user      User?      @relation(fields: [userId], references: [id])
  items     CartItem[]
  lastNotifiedAt DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

// --------------------------------------
// ENGAGEMENT FEATURES
// --------------------------------------

model Wishlist {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  productId String   @db.ObjectId
  product   Product  @relation(fields: [productId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, productId])
}

model Review {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  productId String   @db.ObjectId
  product   Product  @relation(fields: [productId], references: [id])
  rating    Int
  comment   String?
  isFeatured Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // Added for consistency
}

model StoreSetting {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  value     String
  isActive  Boolean  @default(true)
  updatedAt DateTime @updatedAt
}

model Banner {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  imageUrl  String
  link      String?
  title     String?
  isActive  Boolean  @default(true)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PricingRule {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  minCartValue    Float
  discountPercent Float
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model CartItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  cartId    String   @db.ObjectId
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String   @db.ObjectId
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int      @default(1)
  addedAt   DateTime @default(now())
}

model Order {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  userId          String?     @db.ObjectId
  user            User?       @relation(fields: [userId], references: [id])
  
  items           OrderItem[]
  
  // Pricing Snapshot
  totalAmount     Float
  currency        String      @default("INR")
  
  // Status
  status          OrderStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  
  // Payment Details (Razorpay)
  razorpayOrderId   String?
  razorpayPaymentId String?
  
  // GST & B2B
  invoiceNumber     String?
  isB2B             Boolean?    @default(false)
  customerGSTIN     String?
  businessName      String?
  placeOfSupply     String?
  taxAmount         Float?
  cgstAmount        Float?
  sgstAmount        Float?
  igstAmount        Float?
  billingAddress    Json?

  // Reversal
  creditNoteNumber  String?
  cancelledAt       DateTime?
  
  // Shipping
  shippingAddress Address

  // Shiprocket Integration
  shiprocketOrderId String?
  shipmentId        String?
  awbCode           String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model OrderItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String  @db.ObjectId
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id])
  
  name      String  // Snapshot Name
  quantity  Int
  price     Float   // Snapshot Price
}

type Address {
  fullName  String
  street    String
  city      String
  state     String
  zip       String
  country   String
  phone     String
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

// --------------------------------------
// INVENTORY & SUPPLY CHAIN
// --------------------------------------

model MaterialStock {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  type      String   // "GOLD_18K", "GOLD_22K", "DIAMOND_VVS1", etc.
  quantity  Float    // grams or carats
  unit      String   // "g" or "ct"
  lastRestockedAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Vault {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  name      String    // "Main Warehouse", "Showroom", "Exhibition"
  location  String?
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model InventoryLog {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  productId   String?  @db.ObjectId
  materialId  String?  @db.ObjectId
  action      String   // "STOCK_ADD", "STOCK_REMOVE", "MATERIAL_DEDUCT", "TRANSFER"
  quantity    Float
  reason      String?  // "Sale", "Restock", "Damage"
  performedBy String?  @db.ObjectId // User ID
  createdAt   DateTime @default(now())
}

model SerialRecord {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  serialNumber String  @unique // RFID / Barcode ID
  productId   String   @db.ObjectId
  status      String   @default("AVAILABLE") // "AVAILABLE", "SOLD", "RESERVED"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LoyaltyLog {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id])
  action      String   // "EARNED", "REDEEMED", "EXPIRED", "ADJUSTED"
  points      Int
  orderId     String?  @db.ObjectId // Optional link to an order
  description String?
  createdAt   DateTime @default(now())
}

